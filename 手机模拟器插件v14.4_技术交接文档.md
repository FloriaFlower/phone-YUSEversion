# 手机模拟器插件 v14.4 - 技术交接文档

**版本**: 14.4 (模块化重构 & 异步UI初始化)
**文档更新日期**: 2025-08-18

## 1. 引言 (Introduction)

### 1.1 项目概述
手机模拟器插件是一款深度集成于 SillyTavern 环境的交互式前端应用。其核心目标是将AI生成的特定格式文本指令，实时转换为一个高度仿真的、功能丰富的智能手机用户界面。通过这种方式，它极大地增强了角色扮演的沉浸感，为用户提供包括即时通讯、社交媒体、邮件、通话在内的多维度互动体验。

### 1.2 v14.4 版本核心特性
此版本是项目架构的一次重大飞跃，标志着插件从一个单一脚本演进为一个**现代化的、基于模块的前端应用**。核心更新包括：
- **模块化文件结构**: 代码被彻底拆分为多个独立的JS模块（如 `ui.js`, `dataHandler.js`, `parser.js` 等），并进一步细分为 `ui_modules` 和 `data_modules`，极大地提升了代码的可读性、可维护性和可扩展性。
- **异步UI初始化**: 从根本上解决了先前版本中存在的“UI加载竞态条件”问题。插件不再假设HTML元素已存在，而是通过 `SillyTavern.renderExtensionTemplateAsync` API **主动、异步地**从 `panel.html` 模板创建并注入UI，确保所有后续操作都在UI元素确实存在于DOM中之后才执行。这是v14版本最关键的稳定性修复。
- **依赖注入**: 明确了模块间的依赖关系，并通过 `init` 函数将核心API（SillyTavern, TavernHelper, jQuery）和模块间的引用进行传递，降低了模块间的耦合度。

---

## 2. 核心架构 (Core Architecture)

插件采用**模块化**、**状态驱动**和**异步初始化**的设计思想。

- **模块化 (Modularity)**: 代码被拆分为多个职责单一的JS文件，并通过ES6模块（`import`/`export`）进行组织。
  - **主入口 (`script.js`)**: 负责检测核心API、协调所有模块的初始化流程、并绑定顶层事件监听器。
  - **核心模块 (`/modules`)**:
    - `config.js`: 全局静态配置。
    - `state.js`: 应用的单一数据源和状态中心。
    - `sounds.js`: 管理所有UI音效。
    - `parser.js`: 负责解析AI的文本指令。
    - `dataHandler.js`: 作为数据处理的“聚合器”，本身导入并暴露所有 `data_modules` 的功能。
    - `ui.js`: 作为UI管理的“聚合器”，本身导入并暴露所有 `ui_modules` 的功能。
  - **子模块 (`/modules/*_modules`)**: 进一步将UI和数据处理逻辑拆分为更小的单元，例如 `renderChat.js` 专门负责渲染聊天界面，`actions.js` 专门负责写入数据。

- **状态驱动 (State-Driven)**: 严格遵循单向数据流原则。
  1.  **AI/用户输入** 触发 `DataHandler` 中的逻辑。
  2.  `DataHandler` 处理业务逻辑并更新**世界书 (持久化层)**。
  3.  `DataHandler` 调用 `fetchAllData` 从世界书拉取最新数据，更新 `PhoneSim_State` **(应用状态层)**。
  4.  `UI` 模块根据新的 `PhoneSim_State` **重新渲染界面**。

- **异步初始化 (Asynchronous Initialization)**: 这是v14架构的核心。
  1. `script.js` 等待SillyTavern核心API就绪。
  2. 调用 `PhoneSim_UI.initializeUI()`。
  3. `initializeUI` **`await`** `SillyTavern.renderExtensionTemplateAsync()` 来获取`panel.html`的内容。
  4. 将获取到的HTML注入到DOM中。
  5. 只有在注入成功后，`script.js` 才会继续执行，绑定事件监听器和加载数据。这从根源上杜绝了尝试操作不存在元素的错误。

---

## 3. 模块详解 (Module Deep Dive)

### 3.1 `script.js`: 应用引导程序
- **职责**:
  1. 轮询检测 `SillyTavern`, `TavernHelper`, `jQuery` 等核心API是否可用。
  2. 在API就绪后，调用 `mainInitialize` 函数启动整个应用。
  3. `mainInitialize` 负责按正确顺序初始化所有模块（State -> Sounds -> DataHandler -> UI）。
  4. **调用并等待 `PhoneSim_UI.initializeUI()` 的完成**，这是启动流程中的关键异步步骤。
  5. 在UI创建成功后，绑定全局的SillyTavern事件（如 `MESSAGE_RECEIVED`）到 `DataHandler.mainProcessor`。

### 3.2 `/modules/*.js`: 核心单体模块
- **`config.js`**: 存储所有不变的常量，如世界书条目名、DOM ID等。
- **`state.js`**: 内存中的单一状态树，管理UI可见性、当前活动视图、暂存的用户操作等。通过 `localStorage` 持久化非核心UI状态。
- **`sounds.js`**: 统一管理音效播放，并受 `PhoneSim_State.customization.isMuted` 控制。
- **`parser.js`**: 将AI的文本指令转换为结构化的JavaScript对象，包含跨天时间戳处理逻辑。

### 3.3 `/modules/dataHandler.js` & `/data_modules/`
`dataHandler.js` 是一个聚合模块，它本身不包含复杂逻辑，而是从以下子模块导入并导出功能：
- **`processor.js`**: 包含 `mainProcessor`，是处理AI新消息的总入口，负责解析、分类和分发指令。
- **`actions.js`**: 包含所有**写入/修改**数据的操作，如 `_updateWorldbook`, `commitStagedActions`, `claimTransaction`。`_updateWorldbook` 是与SillyTavern世界书交互的唯一接口，保证了数据写入的原子性和安全性。
- **`fetch.js`**: 包含所有**读取**数据的操作，如 `fetchAllData`, `fetchAllContacts` 等，负责将世界书的数据同步到 `PhoneSim_State`。

### 3.4 `/modules/ui.js` & `/ui_modules/`
`ui.js` 同样是聚合模块，整合了UI的各个部分：
- **`core.js`**: 包含最核心的UI生命周期函数 `initializeUI` 和 `togglePanel`，以及视图管理器 `showView`。
- **`events.js`**: 包含 `addEventListeners` 函数，集中管理插件内几乎所有的用户交互事件监听。
- **`renderChat.js`**, **`renderMoments.js`**, 等: 每个文件负责渲染一个特定的复杂视图（如聊天列表、聊天窗口、朋友圈时间线）。
- **`components.js`**: 负责渲染可复用的UI组件，如富文本消息（红包、语音）、弹窗等。
- **`utils.js`**: 包含UI相关的辅助函数，如 `updateScaleAndPosition`, `generateDefaultAvatar`, `compressImage` 等。

---

## 4. 数据流 & 生命周期 (Data Flow & Lifecycle)

1.  **初始化 (Initialization)**:
    -   `script.js` 等待核心API。
    -   `mainInitialize()` 启动。
    -   `PhoneSim_State.init()` 和 `loadUiState()` 初始化状态。
    -   `PhoneSim_DataHandler.init()` 和 `PhoneSim_UI.init()` 初始化数据和UI模块。
    -   **`await PhoneSim_UI.initializeUI()`**:
        -   从 `panel.html` 异步加载模板。
        -   将模板HTML注入主页面 `<body>`。
        -   创建开关按钮。
        -   运行 `populateApps`, `applyCustomizations`, `addEventListeners` 等一次性设置。
    -   `mainInitialize()` 收到 `initializeUI` 成功的信号，继续执行。
    -   绑定 `MESSAGE_RECEIVED` 等事件。
    -   `togglePanel(true)` (如果状态为可见) 会触发 `fetchAllData` 并进行首次渲染。

2.  **接收新消息 (Receiving AI Message)**:
    -   `MESSAGE_RECEIVED` 事件触发 `DataHandler.mainProcessor`。
    -   `mainProcessor` (在 `processor.js` 中) 调用 `Parser` 解析指令。
    -   指令被分发到 `_handleChatCommands`, `_handleMomentCommands` 等处理函数。
    -   处理函数调用 `_updateWorldbook` (在 `actions.js` 中) 将新数据写入世界书。
    -   `fetchAllData` (在 `fetch.js` 中) 重新从世界书加载全部数据到 `PhoneSim_State`。
    -   `UI` 的渲染函数被调用，根据更新后的 `PhoneSim_State` 刷新界面。

---

## 5. 外部依赖 (External Dependencies)
- **SillyTavern Context API**: 插件运行的核心，提供事件系统、生成请求、模板渲染等功能。
- **TavernHelper API**: 提供与世界书交互 (`getWorldbook`, `replaceWorldbook`) 和执行斜杠命令等高级功能。
- **jQuery ($)**: 用于简化DOM操作和事件绑定。
- **emoji-picker-element**: 用于聊天输入框的Emoji选择器，通过CDN动态加载。