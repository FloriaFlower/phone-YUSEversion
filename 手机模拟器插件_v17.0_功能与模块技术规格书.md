# 手机模拟器插件 v17.0 - 功能与模块技术规格书

**文档版本**: 1.0 (2025-08-20)
**目的**: 本文档是手机模拟器插件的**最终技术蓝图**。其核心目标是**将每一个用户可见的功能点，精确地映射到实现它的代码模块与核心函数**。这份文档旨在成为未来开发和维护的“单一事实来源”，从根本上杜绝因不了解功能而误删代码的情况，并为所有开发者提供清晰的导航。

---

## 1. 核心架构与概念 (Core Architecture & Concepts)

-   **模块化 (Modularity)**: 代码被严格拆分为 `dataHandler` (负责所有数据逻辑与状态管理) 和 `ui` (负责所有DOM渲染与事件处理) 两大核心。这两个核心又分别由更细分的子模块 (`/data_modules/` 和 `/ui_modules/`) 构成，实现了高度的功能内聚与低耦合。
-   **状态驱动 (State-Driven)**: 所有UI的渲染都必须是中央状态 `PhoneSim_State` 的直接反映。数据流严格单向：`AI/用户输入` -> `DataHandler` -> `更新世界书` -> `重新获取数据并更新State` -> `UI模块根据新State重绘`。
-   **AI "API" 合约 (AI "API" Contract)**: 插件的运作**完全依赖于AI严格遵守预定义的输出格式**。所有格式指南 (`手机交互AI输出格式指南_*.md`) 是AI与前端之间的“API合约”，任何偏离都将导致解析失败。

---

## 2. 功能与代码映射 (Feature-to-Code Mapping)

### 2.1 通用/系统功能 (General / System)

| 功能点 (Feature) | 描述 (Description) | UI 元素 (UI Elements) | 核心代码 (Core Logic) |
| :--- | :--- | :--- | :--- |
| **插件面板的加载** | 使用标准 `fetch` API 异步加载 `panel.html` 并注入DOM，确保UI加载的绝对可靠性。 | `panel.html` | `ui_modules/core.js` -> `initializeUI()` |
| **面板显示/隐藏** | 通过悬浮按钮切换手机界面的可见性。 | `#phone-sim-toggle-btn-v10-0` | `ui_modules/core.js` -> `togglePanel()` |
| **面板拖动与缩放** | 允许用户拖动面板，并根据窗口大小自动缩放。 | `.status-bar` (拖动句柄) | `ui_modules/utils.js` -> `makeDraggable()`, `updateScaleAndPosition()` |
| **视图切换与动画** | 管理所有应用和页面间的切换，并应用符合逻辑的过渡动画（缩放、滑动等）。 | `.view`, `.app-block` | `ui_modules/core.js` -> `showView()` |
| **AI指令总处理器** | 接收SillyTavern消息，解析所有`[app:...]`指令，并分发给相应的处理函数。 | - | `data_modules/processor.js` -> `mainProcessor()` |
| **玩家操作提交** | 将玩家在UI上的所有操作（发消息、点赞等）暂存，并通过一个按钮统一提交给AI。 | `#phone-sim-commit-btn-v10-0` | `data_modules/actions.js` -> `commitStagedActions()` |

### 2.2 电话 (Phone / Call) - **【高风险功能区】**

**此模块功能紧密耦合，修改时需特别谨慎，以防类似之前通话功能被误删的情况重演。**

| 功能点 (Feature) | 描述 (Description) | UI 元素 (UI Elements) | 核心代码 (Core Logic) |
| :--- | :--- | :--- | :--- |
| **模拟来电振铃** | 收到`[app:Phone, type:IncomingCall]`指令后，显示一个全屏来电界面，播放铃声。 | `.voice-call-modal` | `ui_modules/renderCall.js` -> `showRingingModal()` |
| **接听/拒绝通话** | 用户点击按钮，将“接听”或“拒绝”的系统提示发送给AI，由AI生成后续通话内容或剧情。 | `.accept-call`, `.reject-call` | `ui_modules/events.js` -> (相应按钮的点击事件处理器) |
| **通话中界面** | 显示通话双方的对话记录、头像、计时器等。支持微信语音和原生电话两种风格。 | `#voicecall-view`, `#phonecall-view` | `ui_modules/renderCall.js` -> `showVoiceCall()`, `showPhoneCall()` |
| **更新通话内容** | 收到新的`[app:微信, type:语音]`或`[app:电话, type:电话]`指令后，在通话界面追加新内容。 | `.conversation-scroll` | `ui_modules/renderCall.js` -> `updateVoiceCall()`, `updatePhoneCall()` |
| **结束通话** | 用户点击挂断，记录通话时长，并向AI发送通话结束的系统提示。 | `.end-call` 按钮 | `ui_modules/renderCall.js` -> `closeCallUI()`, `data_modules/actions.js` -> `logCallRecord()` |
| **通讯录列表** | 在“电话”应用内，显示所有联系人并提供拨号和删除功能。 | `.phone-contact-list` | `ui_modules/renderPhoneEmail.js` -> `renderPhoneContactList()` |
| **通话记录** | 显示所有已完成的通话历史。 | `.call-log-list` | `ui_modules/renderPhoneEmail.js` -> `renderCallLogView()` |

### 2.3 微信 (ChatApp)

| 功能点 (Feature) | 描述 (Description) | UI 元素 (UI Elements) | 核心代码 (Core Logic) |
| :--- | :--- | :--- | :--- |
| **渲染消息列表** | 显示所有对话的概览，按最新消息排序。 | `.chat-list-content` | `ui_modules/renderChat.js` -> `renderContactsList()` |
| **清空聊天记录** | 在消息列表项上悬停出现按钮，用于清空与某个联系人的聊天记录（不删除联系人）。 | `.delete-chat-history-btn` | `data_modules/actions.js` -> `clearChatHistoryForContact()` |
| **渲染聊天窗口** | 使用**虚拟滚动**技术高效显示海量聊天记录。 | `.chat-messages` | `ui_modules/renderChat.js` -> `renderChatView()` |
| **发送/暂存消息** | 用户在输入框输入内容并发送，消息被暂存等待统一提交。 | `.input-field`, `.send-btn` | `data_modules/actions.js` -> `stagePlayerMessage()` |
| **渲染富文本** | 将`[图片:...]`, `[语音:...]`等特殊格式渲染为对应的UI组件。 | `.rich-message` | `ui_modules/components.js` -> `renderRichContent()` |
| **消息操作菜单** | 对消息进行回复、撤回、删除等操作。 | `.message-actions` | `data_modules/actions.js` -> `recallMessageByUid()`, etc. |
| **好友请求处理** | 在“通讯录”或聊天流中显示和处理收到的好友请求。 | `.new-friend-request-item` | `data_modules/actions.js` -> `stageFriendRequestResponse()` |
| **群组管理** | 查看群成员、邀请新成员、创建群聊等。 | `#groupmembers-view`, etc. | `ui_modules/renderGroup.js` |

### 2.4 朋友圈 (Moments) & 个人主页

| 功能点 (Feature) | 描述 (Description) | UI 元素 (UI Elements) | 核心代码 (Core Logic) |
| :--- | :--- | :--- | :--- |
| **渲染朋友圈时间线** | 聚合所有联系人的动态，按时间倒序排列。 | `.moments-timeline` | `ui_modules/renderMoments.js` -> `renderMomentsView()` |
| **渲染个人主页** | 显示指定联系人的封面、头像、签名及其个人动态。 | `#homepage-view` | `ui_modules/renderMoments.js` -> `renderHomepage()` |
| **点赞/评论** | 用户对动态进行点赞或评论，操作被暂存。 | `.like-btn`, `.comment-btn` | `data_modules/actions.js` -> `stagePlayerAction()` |
| **资料更新** | 接收`[app:微信, type:更新资料]`指令，更新角色的签名和封面。 | `.homepage-bio`, `.homepage-header` | `data_modules/processor.js` -> `_handleProfileUpdateCommands()` |

### 2.5 其他应用 (Other Apps)

| 应用 | 功能点 (Feature) | 描述 (Description) | 核心代码 (Core Logic) |
| :--- | :--- | :--- | :--- |
| **邮箱** | `邮件列表/详情` | 显示邮件列表，并可点入查看邮件全文及附件。 | `ui_modules/renderPhoneEmail.js` |
| **浏览器** | `AI生成搜索/网页` | 接收用户输入，由AI动态生成搜索结果页和网页内容。 | `data_modules/browserData.js`, `ui_modules/renderBrowser.js` |
| **论坛** | `板块/帖子/回复` | 模拟一个完整的BBS论坛，支持发帖和回复。 | `data_modules/forumData.js`, `ui_modules/renderForum.js` |
| **直播中心** | `直播列表/直播间` | 模拟直播平台，支持AI生成直播内容和弹幕。 | `data_modules/liveCenterData.js`, `ui_modules/renderLiveCenter.js` |
| **设置** | `自定义/重置` | 允许用户更换壁纸、头像，以及重置所有数据。 | `data_modules/actions.js -> saveCustomization()`, `resetAllData()` |
