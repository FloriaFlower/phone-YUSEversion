# 手机交互AI输出格式指南 v2.4

## 【核心原则】
在故事中生成任何手机交互信息时，你必须输出高度格式化的文本。插件会读取这些特殊格式，并在手机界面上创建对应的视觉元素。所有格式之外的文本，都将被视为普通的叙事内容。
**所有格式内容都禁止换行。**

---

## 一、 在线聊天（私聊与群聊）
适用场景：通过任何即时通讯应用（如微信、短信、QQ）进行的实时文字交流。

**统一格式:**
[key1:value1, key2:value2, key3:value3, ...]
**注意:** 所有键值对都在一个方括号内，用逗号 `,` 分隔。键和值之间用冒号 `:` 分隔。消息内容现在也是一个 `content` 键值对。

### 1. 私聊消息
用于一对一的对话。**为了解决AI可能会生成玩家自己发送消息的场景，强烈推荐使用新的“定向消息”格式。**

#### 1.1 定向消息格式 (推荐)
此格式明确指定了消息的发送方和接收方，最为灵活和准确。

**格式:**
[app:微信, type:私聊, from_id:发送者ID, from_name:发送者昵称, to_id:接收者ID, time:HH:mm, content:消息内容]
- **from_id**: (必须) 发送者的唯一ID。**对于玩家，请固定使用 PLAYER_USER**。对于其他角色，使用其11位手机号。
- **from_name**: (必须) 发送者的昵称。对于玩家，请使用 {{user}}。
- **to_id**: (必须) 接收者的唯一ID。规则同上。
- 其他字段 (app, type, time, content) 与之前相同。

**示例 1 (玩家发给角色):**
...故事描述...
[app:微信, type:私聊, from_id:PLAYER_USER, from_name:{{user}}, to_id:13812345678, time:21:15, content:你那边收到援助了吧，夏同学]
*(插件会将此消息正确地添加到你与“夏同学”的聊天记录中，并显示为已发送。)*

**示例 2 (角色发给玩家):**
...故事描述...
[app:微信, type:私聊, from_id:13812345678, from_name:夏同学, to_id:PLAYER_USER, time:21:16, content:收到了，谢谢关心！]
*(这与之前的旧格式效果相同，但逻辑更清晰。)*

#### 1.2 兼容格式 (仅用于角色发消息给玩家)
如果你不确定如何使用定向格式，可以继续使用旧格式。但请注意，此格式**只能用于角色发送消息给玩家**，不能用于玩家发送消息。

**格式:**
[app:微信, type:私聊, id:手机号码, name:昵称, time:HH:mm, content:消息内容]
- **id**: (必须) 发送消息的**角色**的唯一ID（手机号）。
- **name**: (必须) 发送消息的**角色**的昵称。
- **警告**: id 或 name 字段**绝不能**是 PLAYER_USER 或 {{user}}。

### 2. 群聊消息
用于多人在同一个频道中的对话。

**格式:**
[app:微信, type:群聊, group_id:群号, group_name:群名称, sender_id:发信人手机号, sender_name:发信人昵称, time:HH:mm, content:消息内容]
- **group_id**: (必须) 群组的唯一ID，例如 987654321。
- **group_name**: (必须) 群组当前的显示名称。
- **sender_id**: (必须) 这条消息发送者的唯一ID（手机号）。
- **sender_name**: (必须) 这条消息发送者的当前群昵称。
- 其他字段（app, type, time, content）与私聊相同。

**示例 (仅作参考，禁止直接输出):**
[app:微信, type:群聊, group_id:987654321, group_name:玩家后援会, sender_id:13812345678, sender_name:谢🐟淮, time:14:02, content:欢迎来到我们群。]

### 3. 系统提示 (System Messages)
用于在聊天中显示非对话类的状态信息，例如“你添加了XXX为好友”。

**格式:**
[app:微信, type:系统提示, contact_id:私聊ID或group_群聊ID, time:HH:mm, content:提示内容]
- **type**: (必须) 此处固定为 "系统提示"。
- **contact_id**: (必须) 该提示应在哪一个对话中显示。对于私聊，使用对方的手机号；对于群聊，使用 group_ 前缀加上群号 (例如 group_987654321)。
- **content**: (必须) 提示的具体内容。

**示例:**
[app:微信, type:系统提示, contact_id:13812345678, time:14:03, content:你通过了对方的好友请求，现在可以开始聊天了。]

---

## 二、 富文本与特殊内容
content 字段可以容纳纯文本或一个独立的富文本标签。

### 1. 多行消息 (换行)
在 content 的值中使用 \\n (一个反斜杠加一个小写n) 来表示换行。
[app:微信, type:私聊, from_id:13812345678, from_name:林月, to_id:PLAYER_USER, time:15:30, content:这是消息的第一行。\\n这是第二行。]

### 2. 图片 (已整合)
插件会自动识别 [图片:...] 标签的内容。如果是URL或文件名，则显示为真实图片；如果是描述性文字，则显示为伪图片样式。
- **真实图片**: content:[图片:cat_photo.jpeg]
- **文字描述图片**: content:[图片:一张泛黄的旧照片，上面是一个笑容灿烂的女孩...]

### 3. 其他富文本
- **语音**: content:[语音:8"|嗯...这个嘛，让我再想想。]
- **转账**: content:[转账:200.00|午饭钱]
- **红包**: content:[红包:88.88|恭喜发财，大吉大利！]
- **定位**: content:[定位:市中心购物广场]

**完整示例:**
[app:微信, type:私聊, from_id:13812345678, from_name:谢🐟淮, to_id:PLAYER_USER, time:14:05, content:[图片:cat_photo.jpeg]]
[app:微信, type:私聊, from_id:12345, from_name:元气少女-小夏, to_id:PLAYER_USER, time:10:05, content:[语音:3s|你听到没呀哥哥？]]

---

## 三、 语音与电话通话

### 3.1 微信语音通话
用于模拟角色通过**微信**打来语音或在通话中发言。这会打开一个微信风格的通话界面。

**格式:**
[app:微信, type:语音, id:手机号码, name:昵称, time:HH:mm, content:通话时说的第一句话]
- **app**: (必须) 固定为“微信”。
- **type**: (必须) 固定为“语音”。
- **content**: (必须) 角色在接通电话或通话中说的具体内容，将作为通话记录显示在界面上。

**示例 (角色发起通话):**
...故事描述...
[app:微信, type:语音, id:12345, name:元气少女小夏, time:14:40, content:喂…？哥哥？你打过来了？]
[app:微信, type:语音, id:12345, name:元气少女小夏, time:14:41, content:(内心：他居然真的打过来了…好紧张…)]

### 3.2 电话通话 (新)
用于模拟角色通过**手机原生电话功能**打来电话或在通话中发言。这会打开一个系统风格的通话界面。

**格式:**
[app:电话, type:电话, id:手机号码, name:姓名或备注, time:HH:mm, content:通话时说的第一句话]
- **app**: (必须) 固定为“电话”。
- **type**: (必须) 固定为“电话”。
- **name**: (必须) 来电人姓名。插件会优先显示玩家设置的备注名。
- **content**: (必须) 角色在接通电话或通话中说的具体内容。

**示例 (角色用手机号打电话):**
...故事描述...
[app:电话, type:电话, id:13987654321, name:张伟, time:18:00, content:喂，你好，是{{user}}吗？]

---

## 四、 应用指令 (App Commands)
除了聊天和通话，AI还可以直接操作手机应用，例如创建一封新邮件或模拟来电。

### 1. 新建邮件 (New Email)
在邮箱App中创建一封新邮件。

**格式:**
[app:Email, type:New, from_id:手机号, from_name:发件人, subject:主题, time:HH:mm, content:邮件正文, attachment_name:附件名, attachment_desc:附件描述]
- **app**: (必须) 固定为 Email。
- **type**: (必须) 固定为 New。
- **from_id, from_name, subject, time, content**: (必须) 邮件的核心信息。
- **attachment_name, attachment_desc**: (可选) 如果邮件包含附件，则填写。

**示例:**
[app:Email, type:New, from_id:hr@megacorp.com, from_name:MegaCorp HR, subject:面试邀请, time:09:30, content:尊敬的{{user}}，感谢您的申请，我们诚邀您参加面试..., attachment_name:公司介绍.pdf, attachment_desc:2.5MB]

### 2. 模拟来电 (Incoming Call)
触发一个来电界面，让玩家选择接听或挂断。此指令是通用的，可用于微信语音或电话。玩家接听后，你的下一条消息应使用 [app:微信, type:语音,...] 或 [app:电话, type:电话,...] 来正式开始通话。

**格式:**
[app:Phone, type:IncomingCall, from_id:手机号, from_name:来电人]
- **app**: (必须) 固定为 Phone。
- **type**: (必须) 固定为 IncomingCall。
- **注意**: 此指令不需要 time 或 content。

**示例:**
...你的手机屏幕突然亮了起来，铃声大作...
[app:Phone, type:IncomingCall, from_id:13812345678, from_name:林若曦]

---

## 五、 朋友圈动态 (Moments)
用于模拟角色在朋友圈（或类似社交平台）发布动态。这会在手机界面上创建一个可视化的动态卡片。

**格式:**
[app:微信, type:新动态, data:JSON对象]
- **app**: (必须) 固定为“微信”。
- **type**: (必须) 固定为“新动态”。
- **data**: (必须) 一个包含动态所有信息的 **JSON对象**。
  - **注意：** JSON内容必须严格遵循格式，所有字符串键和值都必须用双引号 `"` 包裹。

**`data` JSON对象内部字段:**
{
  "动态id": "moment_unique_id",
  "发布者id": "发动态人的手机号",
  "time": "HH:mm",
  "内容": "动态的文字内容。",
  "图片": ["image1.jpg", "image2.png"],
  "地点": "海边咖啡馆",
  "点赞": ["点赞人1的手机号", "点赞人2的手机号"],
  "评论": [
    {"commenterId": "评论人1的手机号", "text": "第一条评论内容。"},
    {"commenterId": "评论人2的手机号", "text": "第二条评论内容。"}
  ]
}
- **动态id**: (必须) 动态的唯一ID。用于后续的点赞和评论更新。
- **发布者id**: (必须) 发布者的唯一ID（手机号），必须与聊天中的ID保持一致。
- **time**: (必须) 发布时间（HH:mm）。
- **内容**: (必须) 动态的文本内容，可以包含Emoji和话题标签。
- **图片**: (可选) 一个包含图片URL或文件名的 **数组**。
- **地点**: (可选) 动态发布的地理位置。
- **点赞**: (可选) 一个包含点赞者ID（手机号）的 **数组**。
- **评论**: (可选) 一个评论 **对象数组**。每个对象包含：
    - **commenterId**: (必须) 评论者的ID（手机号）。
    - **text**: (必须) 评论的文本内容。

**示例 (仅作参考，禁止直接输出):**
...今天天气很好，谢予淮发了一条朋友圈...
[app:微信, type:新动态, data:{"动态id":"moment_x_001","发布者id":"13812345678","time":"14:30","内容":"海边的落日，美不胜收。🌅 #摄影 #日常","图片":["sunset.jpg"],"地点":"黄金海岸","点赞":["12345"],"评论":[{"commenterId":"12345","text":"哇，拍得真好！"}]}]

---

## 六、 通用规则与最佳实践
- **叙事包裹数据**: 永远不要只扔出一个干巴巴的格式文本。用一两句故事描述来包裹它（例如“你收到了xx发来的消息...”），这会让体验更沉浸。
- **精确性**: 严格遵守新格式中的所有符号和结构：[] , :。确保键值对完整且正确分隔。对于JSON格式，要确保双引号的正确使用。
- **时间戳**: 请确保在你的回复中，同时也包含一个用于定义全局时间的独立标签 (例如 <WorldState>)，插件会自动读取并结合，生成完整的时间戳。
- **玩家消息处理**: 当系统给予类似 (系统提示: 【微信】回复谢予淮：你好) 的信息时，这代表玩家已经在手机上发了消息。你的任务是只生成对方的回复，不要重复玩家的话。