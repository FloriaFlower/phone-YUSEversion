# Tavern 斜杠指令使用标准指南

**文档版本**: 1.0
**目标**: 明确插件内部调用 SillyTavern 斜杠指令的规范，特别是区分 `/send` 和 `/setinput` 的用途，以确保所有需要AI响应的交互都能被正确触发。

---

## 1. 背景

在开发过程中，我们发现某些用户操作（如添加好友、接听电话）虽然在手机界面上显示了对应的系统提示，但并未触发AI生成后续的剧情。经排查，原因是这些操作错误地使用了 `/send` 指令，而没有调用AI生成流程。

## 2. 核心指令详解

### 2.1 `/send` 指令

-   **功能**: `/send` 的唯一作用是**在前端的聊天记录中插入一条新的消息**。
-   **行为**: 它**不会**向后端发送任何请求，也**不会**触发语言模型（LLM）进行任何计算或生成。它仅仅是一个UI操作。
-   **适用场景**:
    -   显示纯粹的、不需要AI响应的客户端信息。
    -   （在手机模拟器插件中，这种场景**几乎不存在**，因为几乎所有系统提示都暗示着一个需要AI知晓并做出反应的状态变化。）

**示例 (错误用法):**
```javascript
// 这只会让用户在聊天框里看到一行字，但AI对此一无所知。
TavernHelper_API.triggerSlash('/send (系统提示：{{user}}接听了夏诗的通话。)');
```

### 2.2 `/setinput` + `SillyTavern_API.generate()` (标准流程)

-   **功能**: 这是触发一次完整AI剧情推演的标准、可靠方法。
-   **行为**:
    1.  `await triggerSlash('/setinput ...')`: 此命令会将括号内的文本内容（通常是一个系统提示）放入SillyTavern的主输入框中。`await` 确保此操作完成后再继续。
    2.  `SillyTavern_API.generate()`: 此函数会立即触发表单提交，将当前聊天上下文（包括刚刚用 `/setinput` 设置的提示）发送给AI进行处理。
-   **适用场景**:
    -   **所有**需要AI知晓并生成回应的用户操作或系统事件。
    -   包括但不限于：接听/拒绝电话、添加好友、在通话中发言、请求生成新的朋友圈/帖子/直播列表、进行搜索等。

**示例 (正确用法):**
```javascript
const prompt = `(系统提示：{{user}}接听了夏诗的通话。)`;
// 1. 将系统提示放入输入框
await TavernHelper_API.triggerSlash(`/setinput ${JSON.stringify(prompt)}`);
// 2. 触发AI生成
SillyTavern_API.generate();
```
**注意**: 传递给 `/setinput` 的内容如果是包含空格的字符串，最好使用 `JSON.stringify()` 来确保它被视为单个参数。

## 3. 开发规范

-   **强制规定**: 在手机模拟器插件的未来所有开发中，**必须**使用 `/setinput` + `SillyTavern_API.generate()` 的组合来处理所有需要AI响应的事件。
-   **禁止使用**: 除非有极其特殊且明确的理由，否则**禁止**单独使用 `/send` 或 `/send ... | /trigger` 的形式来触发剧情。统一使用标准流程可以极大地提高代码的可读性和可靠性。

遵守此规范，可以从根本上避免“交互无响应”的严重bug，确保插件提供流畅、连贯的沉浸式体验。